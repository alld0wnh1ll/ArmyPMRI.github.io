<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PMRI Officers Directory - Restricted Access</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="header">
        <h1>PMRI Officers Directory</h1>
    </div>

    <div class="content">
        <div class="introduction">
            <h2>Restricted Access</h2>
            <p>
                This page contains sensitive information about current PMRI officers. Access is restricted to authorized personnel only.
            </p>
        </div>

        <div class="login-section">
            <div class="login-container">
                <h3>GitHub Authentication Required</h3>
                <p class="auth-info">
                    This page requires GitHub authentication. Please ensure you have the necessary permissions to access this content.
                </p>
                <div class="auth-button">
                    <a href="https://github.com/login/oauth/authorize?client_id=Ov23li1PPGF2lf3IRVW7&redirect_uri=https://alld0wnh1ll.github.io/officers.html&scope=repo" class="github-auth-button">
                        Login with GitHub
                    </a>
                </div>
            </div>
        </div>

        <div id="officersContent" class="officers-content" style="display: none;">
            <h2>Current PMRI Officers</h2>
            <div class="table-container">
                <div class="loading-message">Loading officer data...</div>
                <table class="officers-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Name</th>
                            <th>Branch</th>
                            <th>Research Focus</th>
                            <th>Expected Graduation</th>
                            <th>Contact</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Table data will be populated dynamically -->
                    </tbody>
                </table>
            </div>
            <div class="download-section">
                <a href="#" id="excelDownload" class="resource-link" onclick="return handleDownload(event)">Download Full Officer List (Excel)</a>
            </div>
        </div>

        <div class="sidebar">
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="orientation.html">Orientation Overview</a></li>
                <li><a href="resources.html">Military & Academic Resources</a></li>
                <li><a href="faq.html">Frequently Asked Questions</a></li>
                <li><a href="contacts.html">Contacts & Points of Contact</a></li>
                <li><a href="campus-life.html">Campus Life & Community</a></li>
            </ul>
        </div>
    </div>

    <script>
        // Enhanced authentication and redirection script
        document.addEventListener('DOMContentLoaded', function() {
            // Check for OAuth callback in URL parameters (not hash)
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            
            if (code) {
                // We have a GitHub auth code - exchange it for a token using your backend
                // For security, token exchange should happen server-side, not in client JavaScript
                // This is a placeholder for where you would make that request
                exchangeCodeForToken(code);
                
                // Clean up URL after processing the code
                const cleanUrl = window.location.href.split('?')[0];
                window.history.replaceState({}, document.title, cleanUrl);
            } else {
                // No code in URL, check if we have a token stored
                checkAuth();
            }
            
            // Also check for token in hash (backward compatibility with original code)
            if (window.location.hash) {
                const hash = window.location.hash.substring(1);
                const params = new URLSearchParams(hash);
                const token = params.get('access_token');
                
                if (token) {
                    localStorage.setItem('github_token', token);
                    window.location.hash = '';
                    checkAuth();
                }
            }
        });

        // Exchange authorization code for token (should be done server-side)
        function exchangeCodeForToken(code) {
            // In a real implementation, you would call your backend endpoint here
            // For example:
            // fetch('/api/github-auth', {
            //     method: 'POST',
            //     headers: { 'Content-Type': 'application/json' },
            //     body: JSON.stringify({ code: code })
            // })
            // .then(response => response.json())
            // .then(data => {
            //     if (data.access_token) {
            //         localStorage.setItem('github_token', data.access_token);
            //         showOfficersContent();
            //     }
            // });
            
            // For demo/temporary purposes only (insecure - remove in production):
            console.log("Received authorization code:", code);
            // This simulates successful authentication for testing
            localStorage.setItem('github_token', 'demo_token_' + Date.now());
            showOfficersContent();
        }

        // Check if user is authenticated
        function checkAuth() {
            const token = localStorage.getItem('github_token');
            if (token) {
                // Verify token with GitHub API
                fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`
                    }
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Authentication failed');
                })
                .then(userData => {
                    console.log("Authenticated as:", userData.login);
                    
                    // Check if user has access to the repository
                    return fetch('https://api.github.com/repos/alld0wnh1ll/alld0wnh1ll.github.io', {
                        headers: {
                            'Authorization': `token ${token}`
                        }
                    });
                })
                .then(response => {
                    if (response.ok) {
                        showOfficersContent();
                    } else {
                        throw new Error('No repository access');
                    }
                })
                .catch(error => {
                    console.error('Authentication error:', error);
                    localStorage.removeItem('github_token');
                    showLoginSection();
                });
            } else {
                showLoginSection();
            }
        }

        function showOfficersContent() {
            // Hide login and introduction
            document.querySelector('.login-section').style.display = 'none';
            document.querySelector('.introduction').style.display = 'none';
            
            // Show officers content
            const officersContent = document.getElementById('officersContent');
            officersContent.style.display = 'block';
            
            // Load the data
            loadOfficerData();
        }

        function showLoginSection() {
            // Show login and introduction
            document.querySelector('.login-section').style.display = 'flex';
            document.querySelector('.introduction').style.display = 'block';
            
            // Hide officers content
            document.getElementById('officersContent').style.display = 'none';
        }

        // Handle file download
        function handleDownload(event) {
            event.preventDefault();
            const token = localStorage.getItem('github_token');
            if (!token) {
                alert('Please authenticate first');
                return false;
            }

            // Create a temporary link to download the file
            const link = document.createElement('a');
            link.href = 'documents/PMRI Army Students 3.31.25.xlsx';
            link.download = 'PMRI_Army_Students.xlsx';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            return false;
        }

        // Load officer data
        function loadOfficerData() {
            const token = localStorage.getItem('github_token');
            if (!token) return;

            const loadingMessage = document.querySelector('.loading-message');
            const tableBody = document.querySelector('.officers-table tbody');
            
            if (loadingMessage) {
                loadingMessage.style.display = 'block';
            }

            // Fetch the Excel file content
            fetch('documents/PMRI Army Students 3.31.25.xlsx', {
                headers: {
                    'Authorization': `token ${token}`
                }
            })
            .then(response => {
                if (response.ok) {
                    // Hide loading message
                    if (loadingMessage) {
                        loadingMessage.style.display = 'none';
                    }
                    
                    // For demo, populate table with sample data
                    const sampleData = [
                        {rank: "CPT", name: "John Smith", branch: "Infantry", focus: "AI Applications", graduation: "May 2026", contact: "j.smith@example.mil"},
                        {rank: "MAJ", name: "Sarah Johnson", branch: "Signal", focus: "Cybersecurity", graduation: "Dec 2025", contact: "s.johnson@example.mil"},
                        {rank: "LTC", name: "Robert Davis", branch: "Intelligence", focus: "Data Analytics", graduation: "May 2025", contact: "r.davis@example.mil"}
                    ];
                    
                    // Clear existing rows
                    tableBody.innerHTML = '';
                    
                    // Add sample data rows
                    sampleData.forEach(officer => {
                        const row = document.createElement('tr');
                        
                        ['rank', 'name', 'branch', 'focus', 'graduation', 'contact'].forEach(field => {
                            const cell = document.createElement('td');
                            cell.textContent = officer[field];
                            row.appendChild(cell);
                        });
                        
                        tableBody.appendChild(row);
                    });
                    
                    // In a real implementation, you would parse the Excel file here
                    return response.blob();
                } else {
                    throw new Error('Failed to load officer data');
                }
            })
            .catch(error => {
                console.error('Error loading officer data:', error);
                if (loadingMessage) {
                    loadingMessage.textContent = 'Error loading officer data. Please try again.';
                }
            });
        }

        // Make handleDownload accessible globally for onclick
        window.handleDownload = handleDownload;
    </script>
</body>
</html>